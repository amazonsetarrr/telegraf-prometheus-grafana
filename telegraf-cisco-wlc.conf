# Telegraf Configuration for Cisco Wireless LAN Controller (WLC) Monitoring  
# Using MIBs: CISCO-PROCESS-MIB, CISCO-MEMORY-POOL-MIB, CISCO-ENVMON-MIB,
# CISCO-LWAPP-AP-MIB, CISCO-LWAPP-DOT11-MIB, AIRESPACE-WIRELESS-MIB, etc.

[global_tags]
  device_type = "cisco_wlc"
  
[agent]
  interval = "60s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = false

###############################################################################
#                            OUTPUT PLUGINS                                  #
###############################################################################

[[outputs.prometheus_client]]
  listen = ":9273"
  metric_version = 2
  collectors_exclude = ["gocollector", "process"]
  string_as_label = true
  export_timestamp = true

###############################################################################
#                            PROCESSOR PLUGINS                               #
###############################################################################

# Add hostname and device info as tags
[[processors.regex]]
  [[processors.regex.tags]]
    key = "agent_host"
    pattern = "^(.*)$"
    replacement = "${1}"
    result_key = "wlc_hostname"

###############################################################################
#                            INPUT PLUGINS                                   #
###############################################################################

# System Information - CISCO-SYSTEM-MIB
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_system"
  timeout = "10s"
  retries = 3

  # System description and info
  [[inputs.snmp.field]]
    name = "sysDescr"
    oid = "1.3.6.1.2.1.1.1.0"
    is_tag = true
  
  [[inputs.snmp.field]]
    name = "sysUpTime"
    oid = "1.3.6.1.2.1.1.3.0"
  
  [[inputs.snmp.field]]
    name = "sysName"
    oid = "1.3.6.1.2.1.1.5.0"
    is_tag = true

# CPU Utilization - CISCO-PROCESS-MIB
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_cpu"
  timeout = "10s"
  retries = 3

  # CPU utilization percentages
  [[inputs.snmp.table]]
    name = "cisco_cpu_util"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "cpu_5sec"
      oid = "1.3.6.1.4.1.9.9.109.1.1.1.1.3"
    
    [[inputs.snmp.table.field]]
      name = "cpu_1min"
      oid = "1.3.6.1.4.1.9.9.109.1.1.1.1.4"
    
    [[inputs.snmp.table.field]]
      name = "cpu_5min"
      oid = "1.3.6.1.4.1.9.9.109.1.1.1.1.5"

# Memory Utilization - CISCO-MEMORY-POOL-MIB
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_memory"
  timeout = "10s"
  retries = 3

  # Memory pool information
  [[inputs.snmp.table]]
    name = "cisco_memory_pool"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "memory_pool_name"
      oid = "1.3.6.1.4.1.9.9.48.1.1.1.2"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "memory_used"
      oid = "1.3.6.1.4.1.9.9.48.1.1.1.5"
    
    [[inputs.snmp.table.field]]
      name = "memory_free"
      oid = "1.3.6.1.4.1.9.9.48.1.1.1.6"

# Environmental Monitoring - CISCO-ENVMON-MIB
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_environmental"
  timeout = "10s"
  retries = 3

  # Temperature sensors
  [[inputs.snmp.table]]
    name = "cisco_temperature"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "temp_desc"
      oid = "1.3.6.1.4.1.9.9.13.1.3.1.2"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "temp_value"
      oid = "1.3.6.1.4.1.9.9.13.1.3.1.3"
    
    [[inputs.snmp.table.field]]
      name = "temp_state"
      oid = "1.3.6.1.4.1.9.9.13.1.3.1.6"

  # Power supply status
  [[inputs.snmp.table]]
    name = "cisco_power_supply"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "power_desc"
      oid = "1.3.6.1.4.1.9.9.13.1.5.1.2"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "power_state"
      oid = "1.3.6.1.4.1.9.9.13.1.5.1.3"

# Access Point Information - CISCO-LWAPP-AP-MIB
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_access_points"
  timeout = "15s"
  retries = 3

  # Access Point table (1.3.6.1.4.1.9.9.513.1.1.1)
  [[inputs.snmp.table]]
    name = "cisco_access_points"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "ap_name"
      oid = "1.3.6.1.4.1.9.9.513.1.1.1.1.5"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "ap_mac_address"
      oid = "1.3.6.1.4.1.9.9.513.1.1.1.1.1"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "ap_ip_address"
      oid = "1.3.6.1.4.1.9.9.513.1.1.1.1.2"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "ap_location"
      oid = "1.3.6.1.4.1.9.9.513.1.1.1.1.6"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "ap_model"
      oid = "1.3.6.1.4.1.9.9.513.1.1.1.1.16"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "ap_serial_number"
      oid = "1.3.6.1.4.1.9.9.513.1.1.1.1.17"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "ap_admin_status"
      oid = "1.3.6.1.4.1.9.9.513.1.1.1.1.37"
    
    [[inputs.snmp.table.field]]
      name = "ap_operation_status"
      oid = "1.3.6.1.4.1.9.9.513.1.1.1.1.38"
    
    [[inputs.snmp.table.field]]
      name = "ap_software_version"
      oid = "1.3.6.1.4.1.9.9.513.1.1.1.1.23"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "ap_boot_version"
      oid = "1.3.6.1.4.1.9.9.513.1.1.1.1.24"
      is_tag = true

# Wireless Interface Statistics - CISCO-LWAPP-DOT11-MIB
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_wireless_interfaces"
  timeout = "15s"
  retries = 3

  # Dot11 radio interface table (1.3.6.1.4.1.9.9.513.1.2.1)
  [[inputs.snmp.table]]
    name = "cisco_wireless_interfaces"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "ap_mac_address"
      oid = "1.3.6.1.4.1.9.9.513.1.2.1.1.1"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "radio_slot_id"
      oid = "1.3.6.1.4.1.9.9.513.1.2.1.1.2"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "radio_admin_status"
      oid = "1.3.6.1.4.1.9.9.513.1.2.1.1.3"
    
    [[inputs.snmp.table.field]]
      name = "radio_operation_status"
      oid = "1.3.6.1.4.1.9.9.513.1.2.1.1.4"
    
    [[inputs.snmp.table.field]]
      name = "radio_current_channel"
      oid = "1.3.6.1.4.1.9.9.513.1.2.1.1.6"
    
    [[inputs.snmp.table.field]]
      name = "radio_tx_power_level"
      oid = "1.3.6.1.4.1.9.9.513.1.2.1.1.7"
    
    [[inputs.snmp.table.field]]
      name = "radio_type"
      oid = "1.3.6.1.4.1.9.9.513.1.2.1.1.34"
      is_tag = true

# Wireless Client Statistics - AIRESPACE-WIRELESS-MIB
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_clients"
  timeout = "15s"
  retries = 3

  # Client statistics table (1.3.6.1.4.1.14179.2.1.4.1)
  [[inputs.snmp.table]]
    name = "cisco_wireless_clients"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "client_mac_address"
      oid = "1.3.6.1.4.1.14179.2.1.4.1.1"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "client_ap_mac_address"
      oid = "1.3.6.1.4.1.14179.2.1.4.1.4"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "client_status"
      oid = "1.3.6.1.4.1.14179.2.1.4.1.9"
    
    [[inputs.snmp.table.field]]
      name = "client_protocol"
      oid = "1.3.6.1.4.1.14179.2.1.4.1.25"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "client_rssi"
      oid = "1.3.6.1.4.1.14179.2.1.4.1.7"
    
    [[inputs.snmp.table.field]]
      name = "client_snr"
      oid = "1.3.6.1.4.1.14179.2.1.4.1.26"
    
    [[inputs.snmp.table.field]]
      name = "client_bytes_sent"
      oid = "1.3.6.1.4.1.14179.2.1.4.1.2"
      conversion = "int"
    
    [[inputs.snmp.table.field]]
      name = "client_bytes_received"
      oid = "1.3.6.1.4.1.14179.2.1.4.1.3"
      conversion = "int"
    
    [[inputs.snmp.table.field]]
      name = "client_packets_sent"
      oid = "1.3.6.1.4.1.14179.2.1.4.1.18"
      conversion = "int"
    
    [[inputs.snmp.table.field]]
      name = "client_packets_received"
      oid = "1.3.6.1.4.1.14179.2.1.4.1.19"
      conversion = "int"

# WLAN (SSID) Information - AIRESPACE-WIRELESS-MIB  
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_wlans"
  timeout = "10s"
  retries = 3

  # WLAN configuration table (1.3.6.1.4.1.14179.2.1.1.1)
  [[inputs.snmp.table]]
    name = "cisco_wlans"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "wlan_id"
      oid = "1.3.6.1.4.1.14179.2.1.1.1.1"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "wlan_ssid"
      oid = "1.3.6.1.4.1.14179.2.1.1.1.2"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "wlan_enabled"
      oid = "1.3.6.1.4.1.14179.2.1.1.1.3"
    
    [[inputs.snmp.table.field]]
      name = "wlan_security_policy_enabled"
      oid = "1.3.6.1.4.1.14179.2.1.1.1.38"
    
    [[inputs.snmp.table.field]]
      name = "wlan_broadcast_ssid"
      oid = "1.3.6.1.4.1.14179.2.1.1.1.51"

# Rogue AP Detection - AIRESPACE-WIRELESS-MIB
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_rogue_aps"
  timeout = "10s"
  retries = 3

  # Rogue AP table (1.3.6.1.4.1.14179.2.1.5.1)
  [[inputs.snmp.table]]
    name = "cisco_rogue_aps"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "rogue_ap_mac_address"
      oid = "1.3.6.1.4.1.14179.2.1.5.1.1"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "rogue_ap_ssid"
      oid = "1.3.6.1.4.1.14179.2.1.5.1.17"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "rogue_ap_rssi"
      oid = "1.3.6.1.4.1.14179.2.1.5.1.3"
    
    [[inputs.snmp.table.field]]
      name = "rogue_ap_channel"
      oid = "1.3.6.1.4.1.14179.2.1.5.1.4"
    
    [[inputs.snmp.table.field]]
      name = "rogue_ap_type"
      oid = "1.3.6.1.4.1.14179.2.1.5.1.5"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "rogue_ap_state"
      oid = "1.3.6.1.4.1.14179.2.1.5.1.36"

# Mobility Group Information - AIRESPACE-WIRELESS-MIB
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_mobility"
  timeout = "10s"
  retries = 3

  # Mobility member table (1.3.6.1.4.1.14179.2.3.8.1)
  [[inputs.snmp.table]]
    name = "cisco_mobility_members"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "mobility_member_ip"
      oid = "1.3.6.1.4.1.14179.2.3.8.1.2"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "mobility_member_mac_address"
      oid = "1.3.6.1.4.1.14179.2.3.8.1.3"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "mobility_member_status"
      oid = "1.3.6.1.4.1.14179.2.3.8.1.6"

# Global Wireless Statistics - AIRESPACE-WIRELESS-MIB
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_global_stats"
  timeout = "10s"
  retries = 3

  # Global client count
  [[inputs.snmp.field]]
    name = "total_client_count"
    oid = "1.3.6.1.4.1.14179.2.1.8.1.0"
  
  # Global AP count  
  [[inputs.snmp.field]]
    name = "total_ap_count"
    oid = "1.3.6.1.4.1.14179.2.2.1.1.0"

# WLC Network Interface Statistics
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_interfaces"
  timeout = "10s"
  retries = 3

  # Standard interface statistics
  [[inputs.snmp.table]]
    name = "cisco_interface"
    inherit_tags = ["agent_host"]
    
    [[inputs.snmp.table.field]]
      name = "interface_name"
      oid = "1.3.6.1.2.1.2.2.1.2"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "interface_type"
      oid = "1.3.6.1.2.1.2.2.1.3"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "interface_speed"
      oid = "1.3.6.1.2.1.2.2.1.5"
    
    [[inputs.snmp.table.field]]
      name = "interface_admin_status"
      oid = "1.3.6.1.2.1.2.2.1.7"
    
    [[inputs.snmp.table.field]]
      name = "interface_oper_status"
      oid = "1.3.6.1.2.1.2.2.1.8"
    
    [[inputs.snmp.table.field]]
      name = "bytes_in"
      oid = "1.3.6.1.2.1.2.2.1.10"
      conversion = "int"
    
    [[inputs.snmp.table.field]]
      name = "bytes_out"
      oid = "1.3.6.1.2.1.2.2.1.16"
      conversion = "int"
    
    [[inputs.snmp.table.field]]
      name = "packets_in"
      oid = "1.3.6.1.2.1.2.2.1.11"
      conversion = "int"
    
    [[inputs.snmp.table.field]]
      name = "packets_out"
      oid = "1.3.6.1.2.1.2.2.1.17"
      conversion = "int"
    
    [[inputs.snmp.table.field]]
      name = "errors_in"
      oid = "1.3.6.1.2.1.2.2.1.14"
      conversion = "int"
    
    [[inputs.snmp.table.field]]
      name = "errors_out"
      oid = "1.3.6.1.2.1.2.2.1.20"
      conversion = "int"

# Redundancy Information (for HA WLCs)
[[inputs.snmp]]
  agents = ["192.168.1.3:161"]
  version = 2
  community = "public"
  name = "cisco_wlc_redundancy"
  timeout = "10s"
  retries = 3

  # Redundancy status
  [[inputs.snmp.field]]
    name = "redundancy_status"
    oid = "1.3.6.1.4.1.14179.2.3.16.1.0"
  
  [[inputs.snmp.field]]
    name = "redundancy_peer_ip"
    oid = "1.3.6.1.4.1.14179.2.3.16.2.0"
    is_tag = true

###############################################################################
#                     MEASUREMENT TRANSFORMATIONS                            #
###############################################################################

# Calculate percentages and enrich data
[[processors.starlark]]
  source = '''
def apply(metric):
    if metric.name == "cisco_memory_pool":
        if "memory_used" in metric.fields and "memory_free" in metric.fields:
            used = float(metric.fields.get("memory_used", 0))
            free = float(metric.fields.get("memory_free", 0))
            total = used + free
            if total > 0:
                metric.fields["memory_utilization_percent"] = (used / total) * 100
    
    if metric.name == "cisco_interface":
        # Calculate interface utilization if speed is available
        if "bytes_in" in metric.fields and "interface_speed" in metric.fields:
            speed = float(metric.fields.get("interface_speed", 0))
            if speed > 0:
                bits_in = float(metric.fields.get("bytes_in", 0)) * 8
                bits_out = float(metric.fields.get("bytes_out", 0)) * 8
                metric.fields["interface_utilization_in_percent"] = (bits_in / speed) * 100
                metric.fields["interface_utilization_out_percent"] = (bits_out / speed) * 100
    
    # Convert RSSI to positive values for easier reading
    if metric.name == "cisco_wireless_clients" and "client_rssi" in metric.fields:
        rssi = float(metric.fields.get("client_rssi", 0))
        if rssi < 0:
            metric.fields["client_rssi_positive"] = abs(rssi)
    
    if metric.name == "cisco_rogue_aps" and "rogue_ap_rssi" in metric.fields:
        rssi = float(metric.fields.get("rogue_ap_rssi", 0))
        if rssi < 0:
            metric.fields["rogue_ap_rssi_positive"] = abs(rssi)
    
    return metric
'''

# Add device identification tags and enum mappings
[[processors.enum]]
  [[processors.enum.mapping]]
    tag = "temp_state"
    [processors.enum.mapping.value_mappings]
      1 = "normal"
      2 = "warning" 
      3 = "critical"
      4 = "shutdown"
      5 = "notPresent"
      6 = "notFunctioning"

  [[processors.enum.mapping]]
    tag = "power_state"
    [processors.enum.mapping.value_mappings]
      1 = "normal"
      2 = "warning"
      3 = "critical" 
      4 = "shutdown"
      5 = "notPresent"
      6 = "notFunctioning"

  [[processors.enum.mapping]]
    tag = "ap_admin_status"
    [processors.enum.mapping.value_mappings]
      1 = "enable"
      2 = "disable"

  [[processors.enum.mapping]]
    tag = "ap_operation_status"
    [processors.enum.mapping.value_mappings]
      1 = "associated"
      2 = "disassociating"
      3 = "downloading"

  [[processors.enum.mapping]]
    tag = "radio_admin_status"
    [processors.enum.mapping.value_mappings]
      1 = "enable"
      2 = "disable"

  [[processors.enum.mapping]]
    tag = "radio_operation_status"  
    [processors.enum.mapping.value_mappings]
      1 = "up"
      2 = "down"

  [[processors.enum.mapping]]
    tag = "radio_type"
    [processors.enum.mapping.value_mappings]
      1 = "dot11a"
      2 = "dot11b" 
      3 = "dot11g"
      4 = "uwb"

  [[processors.enum.mapping]]
    tag = "client_status"
    [processors.enum.mapping.value_mappings]
      0 = "idle"
      1 = "aaaPending"
      2 = "authenticated"
      3 = "associated"
      4 = "powersave"
      5 = "disassociated"
      6 = "tobedeleted"
      7 = "probing"
      8 = "blacklisted"

  [[processors.enum.mapping]]
    tag = "wlan_enabled"
    [processors.enum.mapping.value_mappings]
      1 = "true"
      2 = "false"

  [[processors.enum.mapping]]
    tag = "wlan_security_policy_enabled"
    [processors.enum.mapping.value_mappings]
      1 = "true" 
      2 = "false"

  [[processors.enum.mapping]]
    tag = "wlan_broadcast_ssid"
    [processors.enum.mapping.value_mappings]
      1 = "true"
      2 = "false"

  [[processors.enum.mapping]]
    tag = "rogue_ap_type"
    [processors.enum.mapping.value_mappings]
      0 = "unknown"
      1 = "malicious"
      2 = "friendly" 
      3 = "unclassified"

  [[processors.enum.mapping]]
    tag = "rogue_ap_state"
    [processors.enum.mapping.value_mappings]
      1 = "internal"
      2 = "external"

  [[processors.enum.mapping]]
    tag = "mobility_member_status"
    [processors.enum.mapping.value_mappings]
      1 = "up"
      2 = "down"

  [[processors.enum.mapping]]
    tag = "interface_admin_status"
    [processors.enum.mapping.value_mappings]
      1 = "up"
      2 = "down"
      3 = "testing"

  [[processors.enum.mapping]]
    tag = "interface_oper_status"
    [processors.enum.mapping.value_mappings]
      1 = "up"
      2 = "down"
      3 = "testing"
      4 = "unknown"
      5 = "dormant"
      6 = "notPresent"
      7 = "lowerLayerDown"

  [[processors.enum.mapping]]
    tag = "redundancy_status"
    [processors.enum.mapping.value_mappings]
      1 = "active"
      2 = "standby"
      3 = "disabled"